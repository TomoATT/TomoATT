version: 3

#################################################
#            computational domian               #
#################################################
domain:
  min_max_dep: [-10.0, 50.0]  # depth in km
  min_max_lat: [30.0, 32.0]   # latitude in degree
  min_max_lon: [30.0, 32.0]   # longitude in degree
  n_rtp: [61, 61, 61]         # number of nodes

source:
  src_rec_file: ../0_generate_files_for_TomoATT/src_rec_files/src_rec_config.dat    # source receiver file (if found, src_dep_lat_lon is ignored)
  # src_rec_file : 'eg3_地震定位简易测试/src_rec_init_loc_single.dat' # source receiver file (if found, src_dep_lat_lon is ignored)
  swap_src_rec: true                # swap source and receiver (true or false)

model:
  init_model_path: ../0_generate_files_for_TomoATT/models/model_ckb_N61_61_61.h5    # path to initial model file (ignored if init_model_type is '1d_*')

parallel: # parameters for parallel computation
  n_sims: 2          # number of simultaneous run
  ndiv_rtp: [2, 2, 1] # number of subdomains
  nproc_sub: 1       # number of subprocess used for each subdomain

output_setting:
  output_dir: OUTPUT_FILES/OUTPUT_FILES_signal # path to output director (default is ./OUTPUT_FILES/)
  output_source_field: false # output the calculated field of all sources
  output_model_dat: true  # output model_parameters_inv_0000.dat or not.
  output_final_model: true # output merged final model or not.
  output_in_process: true # output model at each inv iteration or not.
  single_precision_output: false # output results in single precision or not.
  verbose_output_level: 0 # output internal parameters, if 0, only model parameters are out. Higher level, more internal parameters are output. default: 0
  output_file_format: 0 # in/output file format, if 0: HDF5, if 1: ASCII


#################################################
#          inversion or forward modeling        #
#################################################
# run mode
# 0 for forward simulation only,
# 1 for inversion
# 2 for earthquake relocation
# 3 for inversion+earthquake relocation
run_mode: 0


###################################################
#          model update parameters setting        #
###################################################
model_update: # update model parameters (when run_mode : 1 and 3)
  max_iterations: 1 # maximum number of inversion iterations
  optim_method: 0 # optimization method. 0 : grad_descent, 1 : halve-stepping, 2 : lbfgs (EXPERIMENTAL)

  # common parameters for all optim methods
  step_length: 0.01 # step length of model perturbation at each iteration. 0.01 means maximum 1% perturbation for each iteration.

  # parameters for optim_method 0 (grad_descent)
  optim_method_0:
    step_length_decay: 0.9 # if objective function increase, step size -> step length * step_length_decay. default: 0.9
    step_length_sc: 0.001 # ... # use it also ?

  # parameters for optim_method 1 (halve-stepping) or 2 (lbfgs)
  optim_method_1_2:
    max_sub_iterations: 10 # maximum number of each sub-iteration
    regularization_weight: 100 # weight value for regularization (lbfgs mode only)

  # smoothing
  smoothing:
    smooth_method: 0 # 0: multiparametrization, 1: laplacian smoothing (EXPERIMENTAL)
    l_smooth_rtp: [1, 1, 1] # smoothing coefficients for laplacian smoothing

  # parameters for smooth method 0 (multigrid model parametrization)
  n_inversion_grid: 5 # number of inversion grid sets

  # inversion grid type
  type_invgrid_dep: 0 # 0: uniform inversion grid, 1: flexible grid
  type_invgrid_lat: 0 # 0: uniform inversion grid, 1: flexible grid
  type_invgrid_lon: 0 # 0: uniform inversion grid, 1: flexible grid

  # settings for uniform inversion grid (if type_*_inv : 0)
  n_inv_dep_lat_lon: [10, 10, 10] # number of the base inversion grid points (ignored if type_*_inv : 1)
  min_max_dep_inv: [-10.0, 40.0] # depth in km (Radius of the earth is defined in config.h/R_earth) (ignored if type_dep_inv : 1)
  min_max_lat_inv: [0.0, 1.0]   # latitude in degree
  min_max_lon_inv: [0.0, 1.0]   # longitude in degree

  # settings for flexible inversion grid (if type_*_inv : 1)
  dep_inv: [-7.0, -3.0, 0.0, 3.0, 7.0, 12.0, 18.0, 25.0, 33.0, 42.0, 52.0, 63.0] # depth in km (Radius of the earth is defined in config.h/R_earth)
  lat_inv: [0.0, 1.0] # latitude in degree (ignored if type_lat_inv : 0)
  lon_inv: [0.0, 1.0] # longitude in degree (ignored if type_lon_inv : 0)

  # path to station correction file
  use_sta_correction: false
  sta_correction_file: dummy_sta_correction_file # station correction file path

  # -------------- using absolute traveltime data --------------
  abs_time:
    use_abs_time: true # 'true' for using absolute traveltime data to update model parameters; 'false' for not using (no need to set parameters in this section)
    residual_weight: [1.0, 3.0, 1.0, 0.1] # weight (wt) of residual. wt = residual_weight[2] for res < residual_weight[0]. wt = residual_weight[3] for res > residual_weight[1], and linear weight in between.
    distance_weight: [50.0, 150.0, 1.0, 0.1] # weight of epicenter distance. wt = distance_weight[2] for dis < distance_weight[0]. wt = distance_weight[3] for dis > distance_weight[1], and linear weight in between.

  # -------------- using common source differential traveltime data --------------
  cs_dif_time:
    use_cs_time: false # 'true' for using common source differential traveltime data to update model parameters; 'false' for not using (no need to set parameters in this section)
    residual_weight: [1.0, 3.0, 1.0, 0.1] # weight (wt) of residual.
    azimuthal_weight: [15.0, 30.0, 1.0, 0.1] # weight of azimuth between two stations.

  # -------------- using common receiver differential traveltime data --------------
  cr_dif_time:
    use_cr_time: false # 'true' for using common receiver differential traveltime data to update model parameters; 'false' for not using (no need to set parameters in this section)
    residual_weight: [1.0, 3.0, 1.0, 0.1] # weight (wt) of residual.
    azimuthal_weight: [15.0, 30.0, 1.0, 0.1] # weight of azimuth between two earthquakes.

  # -------------- global weight of different types of data (to balance the weight of different data) --------------
  global_weight:
    balance_data_weight: true # true: over the total weight of the each type of the data. the obj of different data means the average data misfit; no: use original weight (below weight for each type of data needs to be set)
    abs_time_weight: 1.0 # weight of absolute traveltime data,                       default: 1.0
    cs_dif_time_local_weight: 1.0 # weight of common source differential traveltime data,     default: 1.0
    cr_dif_time_local_weight: 1.0 # weight of common receiver differential traveltime data,   default: 1.0
    teleseismic_weight: 1.0 # weight of teleseismic data,                               default: 1.0  (exclude in this version)

  # -------------- inversion parameters (exclude in this version) --------------
  update_slowness: true   # update slowness (velocity) or not.              default: true
  update_azi_ani: true    # update azimuthal anisotropy (xi, eta) or not.   default: false
  update_rad_ani: true    # update radial anisotropy (in future) or not.    default: false

  # -------------- for teleseismic inversion (exclude in this version) --------------
  depth_taper: [-200.0, -100.0]   # kernel weight : depth.  -->  0: -inf ~ taper[0]; 0 ~ 1 : taper[0] ~ taper[1]; 1 : taper[1] ~ inf

#################################################
#          relocation parameters setting        #
#################################################
relocation: # update earthquake hypocenter and origin time (when run_mode : 1)

  # relocation_strategy
  step_length: 0.01   # step length of relocation perturbation at each iteration. 0.01 means maximum 1% perturbation for each iteration.
  step_length_decay: 0.9    # if objective function increase, step size -> step length * step_length_decay. default: 0.9
  rescaling_dep_lat_lon_ortime: [10.0, 10.0, 10.0, 1.0]    # The perturbation is related to <rescaling_dep_lat_lon_ortime>. Unit: km,km,km,second
  max_change_dep_lat_lon_ortime: [5.0, 5.0, 5.0, 0.5]      # the change of dep,lat,lon,ortime do not exceed max_change. Unit: km,km,km,second
  max_iterations: 100   # maximum number of iterations for relocation
  tol_gradient: 0.0001  # threshold value for checking the convergence for each iteration

  # more option for using different types of data is under development (following)
  # -------------- using absolute traveltime data --------------
  abs_time:
    use_abs_time: true   # 'true' for using absolute traveltime data to update model parameters; 'no' for not using (no need to set parameters in this section)
    residual_weight: [1.0, 3.0, 1.0, 0.1]          # weight (wt) of residual. wt = residual_weight[2] for res < residual_weight[0]. wt = residual_weight[3] for res > residual_weight[1], and linear weight in between.
    distance_weight: [50.0, 150.0, 1.0, 0.1]       # weight of epicenter distance. wt = distance_weight[2] for dis < distance_weight[0]. wt = distance_weight[3] for dis > distance_weight[1], and linear weight in between.

  # -------------- using common receiver differential traveltime data --------------
  cr_dif_time:
    use_cr_time: true  # 'true' for using common receiver differential traveltime data to update model parameters; 'no' for not using (no need to set parameters in this section)
    residual_weight: [1.0, 3.0, 1.0, 0.1]          # weight (wt) of residual.
    azimuthal_weight: [10.0, 30.0, 1.0, 0.1]       # weight of azimuth (deg.) between two earthquakes.


####################################################################
#          inversion strategy for tomography and relocation        #
####################################################################
inversion_strategy: # update model parameters and earthquake hypocenter iteratively (when run_mode : 3)

  inv_mode: 0     # 0 for update model parameters and relocation iteratively. (other options for future work)

  # for inv_mode : 0, parameters below are required
  inv_mode_0: # update model for <model_update_N_iter> steps, then update location for <relocation_N_iter> steps, and repeat the process for <max_loop> loops.
    model_update_N_iter : 1
    relocation_N_iter  : 1 
    max_loop : 40



# --- parameters for core solver ---------------------------------------------------------
# --- please do not change the following parameters unless you know what you are doing ---

########################################################################
#            Scheme of Eikonal solver (fast sweeping method)           #
########################################################################
calculation:
  convergence_tolerance: 1e-5
  max_iterations: 500  # max itertions for forward simulation
  stencil_order: 1  # 1 or 3
  stencil_type: 1
  sweep_type: 0     # 0: legacy, 1: cuthill-mckee with shm parallelization

